@page "/chat"
@page "/chat/{RouteUsername}/{Session_Key:int}"
@rendermode InteractiveServer

<style>
    .yellow-border-focus > .mud-input-control-input-container > .mud-input.mud-input-outlined > input:focus-within ~ .mud-input-outlined-border{@($"border-color: {Colors.Yellow.Darken2};")}
    .yellow-border-hover > .mud-input-control-input-container > .mud-input.mud-input-outlined > input:hover ~ .mud-input-outlined-border{@($"border-color: {Colors.Yellow.Darken2};")}
    .yellow-border > .mud-input-control-input-container > .mud-input.mud-input-outlined >  .mud-input-outlined-border{@($"border-color: {Colors.Yellow.Lighten4}");}
</style>

<MudAppBar Fixed="false" Elevation="0" Style="@($"background:{Colors.Yellow.Lighten3}; height: 8vh;")">
    <MudButton @onclick="ToggleChat" Edge="Edge.Start" Style="@($"color:{Colors.Yellow.Darken4}; background:{Colors.Amber.Lighten3}; font-size: 1.2em;")">View Chats</MudButton>
    <MudSpacer />
    <MudText Edge="Edge.End" Style="@($"color:{Colors.Yellow.Darken4}; font-size: 1.75em; font-weight:900;")">LemonChat</MudText>
</MudAppBar>
<MudDrawerContainer Style="@($"background:{Colors.Yellow.Darken2}; height; 92vh;")">
    <MudDrawer Overlay="false" Elevation="0" @bind-Open="@_openChat" Style="@($"color:{Colors.Yellow.Darken4}; background:{Colors.Yellow.Lighten4}; height: 92vh;")">
        <MudDrawerHeader style="padding-left: 25%;"><MudText Typo="Typo.h3" style="font-weight: 700;">@Username</MudText></MudDrawerHeader>
        <div style="padding-left: 100%; height: .5em; width: 50%; background-color:@($"{Colors.Yellow.Darken4}");"></div>
        <br>
        <MudDrawerContainer class="customized-scrollbar" style="padding: 0 5%; overflow: scroll;">
            <MudTextField @bind-Value="CreateChat" class="yellow-border yellow-border-hover yellow-border-focus" Placeholder="New Chat" Variant="Variant.Outlined" Adornment="Adornment.End" OnAdornmentClick="CreateGroup" AdornmentIcon="@Icons.Material.Filled.Add" Style="@($"width: 100%; background:{Colors.Amber.Accent1}; border-radius: 4px;")"></MudTextField>
            <br>
            @foreach(UserInChat group in ChatGroups)
            {
                <MudButton @onclick="() => ChangeGroup(group)">@($"{group.Chat_Name}")</MudButton>
            }
        </MudDrawerContainer>
    </MudDrawer>
    <MudMainContent Style="@($"background:{Colors.Yellow.Darken2}; height: 92vh;")">
        <MudTextField @bind-Value="AddUser" class="yellow-border yellow-border-hover yellow-border-focus" Placeholder="Add user to chat" Variant="Variant.Outlined" Adornment="Adornment.End" OnAdornmentClick="AddUserToChat" AdornmentIcon="@Icons.Material.Filled.Add" Style="@($"width: 80vw; margin: auto; margin-top: -7vh; background:{Colors.Amber.Accent1}; border-radius: 4px;")"></MudTextField>
        <MudPaper Style="@($"background:{Colors.Amber.Accent1}; height:70vh; width: 80vw; margin: auto; margin-top: .5em; border-radius: 4px;")" Elevation="0">
            @foreach(Chat chat in CurrentChat)
            {
                <MudText>@($"{chat.Sent_By}: {chat.Message}")</MudText>
            }
        </MudPaper>
        <MudTextField @bind-Value="InputChat" class="yellow-border yellow-border-hover yellow-border-focus" Placeholder="Send chat" Variant="Variant.Outlined" Adornment="Adornment.End" OnAdornmentClick="SendChat" AdornmentIcon="@Icons.Material.Filled.Send" Style="@($"width: 80vw; margin: auto; background:{Colors.Amber.Accent1}; border-radius: 4px;")"></MudTextField>
    </MudMainContent>
</MudDrawerContainer>

@code {

    List<UserInChat> ChatGroups = [];
    List<Chat> CurrentChat = [];
    int curChatId = 0;
    string AddUser = "";
    string InputChat = "";
    string CreateChat = "";
    bool _openChat = true;

    [Parameter]
    public string? RouteUsername { get; set; }

    [Parameter]
    public int Session_Key { get; set; }

    private string Username = "";

    UserController userController;
    ChatInfoController chatInfoController;
    ChatController chatController;

    protected override void OnInitialized() {
        Username = RouteUsername ?? Username;
        string connectionString = Config.GetConnectionString("Default") ?? "";
        userController = new UserController(connectionString);
        if(!userController.IsCorrectLogin(Username, Session_Key)) Navigation.NavigateTo("/");
        chatInfoController = new ChatInfoController(connectionString);
        chatController = new ChatController(connectionString);
        var timer = new System.Threading.Timer((_) =>
        {
            ChatGroups = chatInfoController.ChatsUserIsIn(Username);
            UpdateChat();
            InvokeAsync(() =>
            {
                StateHasChanged();
            });
        }, null, 0, 1000);
    }

    void AddUserToChat()
    {
        if(!userController.ContainsUser(AddUser)) return;
        chatInfoController.AddUserToChat(curChatId, AddUser);
    }

    void UpdateChat()
    {
        if(curChatId != 0) 
        {
            int largest = CurrentChat.Count > 0 ? CurrentChat.Last().MessageId : 0;
            if(largest != 0)
            {
                List<Chat> chats = chatController.GetChats(curChatId);
                if(chats.Last().MessageId > largest) CurrentChat.Add(chats.Last());
            } else CurrentChat = chatController.GetChats(curChatId);
        }
    }

    void SendChat()
    {
        if(CurrentChat == null) return;
        chatController.SendChat(curChatId, Username, InputChat);
        UpdateChat();
    }

    void ToggleChat()
    {
        _openChat = !_openChat;
    }

    void CreateGroup()
    {
        chatInfoController.CreateChat(Username, CreateChat);
        ChatGroups = chatInfoController.ChatsUserIsIn(Username);
        CreateChat = "";
    }

    void ChangeGroup(UserInChat group)
    {
        curChatId = group.ChatId;
        UpdateChat();
    }

}